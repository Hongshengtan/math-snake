
<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>数学贪吃蛇（简化版 + 大球）</title>
<meta name="description" content="题目更简单、答案球更大更清晰的数学贪吃蛇。复习正指数、负指数、平方根与基础对数。">
<style>
  :root{--bg:#0b1020;--panel:#101935;--border:#3a4b8a;--pill:#1e2b54;--accent:#3a6df0;--grid:#ffffff0d;
        --snakeHead:#58ffb1;--snake:#2ee59d;--orb:#ffd166;--text:#e9ecf1;}
  *{box-sizing:border-box}
  body { background:var(--bg); color:var(--text); font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
         margin:0; display:flex; flex-direction:column; align-items:center; min-height:100vh; }
  h1 { font-weight:800; margin:16px 0 8px; text-align:center; }
  #wrap { position: relative; }
  #game { background:var(--panel); border:2px solid var(--border); box-shadow: 0 0 20px rgba(0,0,0,.35); display:block; }
  #hud { width:min(94vw, 640px); display:flex; flex-wrap:wrap; gap:8px; justify-content:space-between; margin:8px 0 16px; font-size:16px;}
  .pill { background:var(--pill); padding:8px 12px; border-radius:999px; font-size:18px; }
  #msg { position:absolute; inset:0; display:flex; align-items:center; justify-content:center;
         background:rgba(0,0,0,.55); color:#fff; font-size:20px; text-align:center; padding:16px; }
  #msg.hidden { display:none; }
  button { background:var(--accent); color:#fff; border:none; padding:12px 16px; border-radius:12px; cursor:pointer; font-weight:800; font-size:18px; }
  button:hover { filter:brightness(1.08); }
  #legend { width:min(94vw, 640px); font-size:16px; line-height:1.75; color:#cfd7ff; margin:10px 0 12px;text-align:left;}
  code { background:#17213f; padding:2px 6px; border-radius:6px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;}
  kbd { background:#222; border:1px solid #444; border-bottom-width:3px; padding:2px 8px; border-radius:6px;}
  .footer{opacity:.7; font-size:12px; margin:10px 0 30px;}
  @media (max-width:660px){
    #game{ width:94vw; height:94vw; }
    #hud{ width:94vw; }
  }
</style>
</head>
<body>
  <h1>🐍 数学贪吃蛇（简化版 + 大球）</h1>
  <div id="legend">
    玩法：按 <kbd>空格</kbd> 开始/暂停，使用方向键移动。<br/>
    本版题目更简单：仅包含 <b>正指数</b>、<b>负指数</b>、<b>平方根</b>、以及 <b>基础对数</b>（底 2 或 4，且答案为整数）。<br/>
    球体更大、字体更粗，更容易看清选项。吃到正确答案 ➜ 加分并变长；吃错 ➜ 游戏结束。
  </div>
  <div id="hud">
    <div class="pill">分数：<span id="score">0</span></div>
    <div class="pill">速度：<span id="speed">中等</span></div>
    <div class="pill">当前题：<span id="qtext">按空格开始</span></div>
  </div>
  <div id="wrap" style="width:min(94vw,640px);height:min(94vw,640px);">
    <canvas id="game" width="640" height="640"></canvas>
    <div id="msg" aria-live="polite">
      <div>
        <div style="font-size:26px; font-weight:900; margin-bottom:12px;">按 <kbd>空格</kbd> 开始 / 暂停</div>
        <div style="opacity:.95">方向键移动。吃对答案变长，吃错就 GG。<br/>再次按空格可暂停，重新开始请点下面按钮。</div>
        <div style="margin-top:16px;"><button id="restartBtn">重新开始</button></div>
      </div>
    </div>
  </div>
  <div class="footer">© 学习用途。可自由分享此页面文件。</div>

<script>
(function(){
  const canvas = document.getElementById('game');
  const ctx = canvas.getContext('2d');
  const wrap = document.getElementById('wrap');

  // 自适应正方形画布（移动端）
  function fitCanvas(){
    const size = Math.min(wrap.clientWidth, wrap.clientHeight, 680);
    canvas.width = size;
    canvas.height = size;
  }
  window.addEventListener('resize', fitCanvas);
  fitCanvas();

  const W = () => canvas.width, H = () => canvas.height;
  const GRID = 24; // 更大的格子，数字更清晰
  const COLS = () => Math.floor(W()/GRID);
  const ROWS = () => Math.floor(H()/GRID);
  const scoreEl = document.getElementById('score');
  const qtextEl = document.getElementById('qtext');
  const speedEl = document.getElementById('speed');
  const msg = document.getElementById('msg');
  const restartBtn = document.getElementById('restartBtn');

  let running = false;
  let lastTick = 0;
  let tickMs = 150; // 稍微慢一点点
  let snake, dir, nextDir, score, answers, correctKey, questionText;

  function randInt(a,b){ return Math.floor(Math.random()*(b-a+1))+a; }
  function randCell(){
    return {x: randInt(0, COLS()-1), y: randInt(0, ROWS()-1)};
  }
  function cellEq(a,b){ return a.x===b.x && a.y===b.y; }

  function init(){
    snake = [{x:10,y:15},{x:9,y:15},{x:8,y:15}];
    dir = {x:1,y:0}; nextDir = {x:1,y:0};
    score = 0;
    tickMs = 150;
    speedEl.textContent = "中等";
    newQuestion();
    updateHud();
  }

  function updateHud(){
    scoreEl.textContent = score;
    qtextEl.textContent = questionText || "……";
  }

  // ---- 出题器（简化版） ----
  function asStr(x){
    if (typeof x === "number"){
      if (Math.abs(x-Math.round(x))<1e-9) return String(Math.round(x));
      return String(x.toFixed(3)).replace(/0+$/,'').replace(/\.$/,''); 
    }
    return String(x);
  }

  function q_pow_integer(){
    // a^n -> ?, a in [2..6], n in [1..4]
    const a = [2,3,4,5,6][randInt(0,4)];
    const n = randInt(1,4);
    const val = Math.pow(a,n);
    return { text: `${a}^${n} = ?`, correct: asStr(val) };
  }

  function q_pow_negative(){
    // a^{-n}，a in [2..6], n in [1..3]
    const a = [2,3,4,5,6][randInt(0,4)];
    const n = randInt(1,3);
    return { text: `${a}^(-${n}) = ?`, correct: `1/${Math.pow(a,n)}` };
  }

  function q_pow_sqrt(){
    // a^{1/2}，完美平方
    const choices = [{a:4, r:2},{a:9, r:3},{a:16,r:4},{a:25,r:5},{a:36,r:6}];
    const pick = choices[randInt(0, choices.length-1)];
    return { text: `${pick.a}^{1/2} = ?`, correct: asStr(pick.r) };
  }

  function q_log_basic(){
    // log_a(x)，a∈{2,4}，结果为整数，-2..4
    const a = [2,4][randInt(0,1)];
    const k = randInt(-2,4);
    const x = Math.pow(a,k);
    return { text: `log_${a}(${x}) = ?`, correct: asStr(k) };
  }

  function q_mix(){
    const bank = [q_pow_integer, q_pow_negative, q_pow_sqrt, q_log_basic];
    return bank[randInt(0, bank.length-1)]();
  }

  function genDistractors(correctStr){
    // 生成 3 个简单干扰项：±1、倒数、×2
    const res = new Set([correctStr]);
    function tweak(str){
      if (/^-?\d+\/\d+$/.test(str)){
        const [n,d] = str.split('/').map(s=>parseInt(s,10));
        const pick = randInt(0,2);
        if (pick===0) return `${d}/${n}`; // 倒数
        if (pick===1) return `${n+1}/${d}`;
        return `${Math.max(1,n-1)}/${d}`;
      } else if (/^-?\d+(\.\d+)?$/.test(str)){
        const v = parseFloat(str);
        const pick = randInt(0,3);
        if (pick===0) return String(v+1);
        if (pick===1) return String(v-1);
        if (pick===2 && v!==0) return `1/${Math.max(1,Math.round(Math.abs(v)))}`;
        return String(v*2);
      } else {
        return str + "'";
      }
    }
    let guard = 0;
    while(res.size<4 && guard<50){ res.add(tweak(correctStr)); guard++; }
    const arr = Array.from(res);
    // 保证包含正确答案
    if (!arr.includes(correctStr)) arr[randInt(0,arr.length-1)] = correctStr;
    // 简单洗牌
    for (let i=arr.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr.slice(0,4);
  }

  function newQuestion(){
    const q = q_mix();
    questionText = q.text;
    const opts = genDistractors(q.correct);
    placeAnswers(opts, q.correct);
    updateHud();
  }

  function placeAnswers(opts, correct){
    // 随机放置 4 个答案球，避开蛇身
    answers = [];
    for (let i=0;i<4;i++){
      let c, tries=0;
      do { c = randCell(); tries++; if(tries>200) break; }
      while ( snake.some(s=>cellEq(s,c)) || answers.some(o=>cellEq(o.pos,c)) );
      answers.push({ pos:c, text:opts[i] });
    }
    correctKey = correct;
  }

  // ---- 输入 ----
  window.addEventListener('keydown', e=>{
    if (e.code === 'Space'){
      running = !running;
      msg.classList.toggle('hidden', running);
      return;
    }
    if (!running) return;
    if (e.key === 'ArrowUp' && dir.y!==1){ nextDir={x:0,y:-1}; }
    else if (e.key === 'ArrowDown' && dir.y!==-1){ nextDir={x:0,y:1}; }
    else if (e.key === 'ArrowLeft' && dir.x!==1){ nextDir={x:-1,y:0}; }
    else if (e.key === 'ArrowRight' && dir.x!==-1){ nextDir={x:1,y:0}; }
  });

  restartBtn.addEventListener('click', ()=>{
    init();
    running = false;
    msg.classList.remove('hidden');
  });

  // ---- 循环 ----
  function loop(ts){
    requestAnimationFrame(loop);
    if (!running) return;
    if (ts - lastTick < tickMs) return;
    lastTick = ts;
    step();
    draw();
  }

  function step(){
    dir = nextDir;
    const head = {x: snake[0].x + dir.x, y: snake[0].y + dir.y};
    // 边缘穿越，降低难度
    head.x = (head.x + COLS()) % COLS();
    head.y = (head.y + ROWS()) % ROWS();

    // 撞到自己 => 结束
    if (snake.some(s=>cellEq(s, head))){
      gameOver("撞到自己啦！");
      return;
    }
    snake.unshift(head);

    // 吃答案
    let ate = false;
    for (let i=0;i<answers.length;i++){
      if (cellEq(answers[i].pos, head)){
        const picked = answers[i].text;
        if (picked === correctKey){
          score++;
          if (score % 6 === 0 && tickMs>80){ tickMs -= 10; speedEl.textContent = tickMs<=100 ? "较快" : "中等"; }
          newQuestion();
          ate = true; // 变长
        } else {
          gameOver("吃错答案了！");
          return;
        }
      }
    }
    if (!ate){ snake.pop(); } // 没吃到就移动尾巴
  }

  function gameOver(reason){
    running = false;
    draw();
    msg.classList.remove('hidden');
    msg.querySelector('div').firstChild.textContent = "游戏结束：" + reason + " 分数：" + score + "。按空格继续或点重新开始。";
  }

  function draw(){
    const w = W(), h = H();
    // 背景
    ctx.fillStyle = "#0f1733";
    ctx.fillRect(0,0,w,h);
    // 网格
    ctx.strokeStyle = "rgba(255,255,255,0.05)";
    ctx.lineWidth = 1;
    for (let x=0;x<=w;x+=GRID){ ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,h); ctx.stroke(); }
    for (let y=0;y<=h;y+=GRID){ ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(w,y); ctx.stroke(); }

    // 蛇
    for (let i=0;i<snake.length;i++){
      ctx.fillStyle = i===0 ? "#58ffb1" : "#2ee59d";
      const s = snake[i];
      ctx.fillRect(s.x*GRID+1, s.y*GRID+1, GRID-2, GRID-2);
    }

    // 更大的答案球 + 更大字体
    for (const a of answers){
      ctx.beginPath();
      ctx.fillStyle = "#ffd166";
      const cx = a.pos.x*GRID + GRID/2;
      const cy = a.pos.y*GRID + GRID/2;
      ctx.arc(cx, cy, GRID*0.48, 0, Math.PI*2); // 半径更大
      ctx.fill();
      ctx.fillStyle = "#102a43";
      ctx.font = "bold " + Math.floor(GRID*0.9) + "px system-ui, -apple-system, Segoe UI, Roboto, Arial"; // 字体更大
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
      ctx.fillText(a.text, cx, cy);
    }

    // 顶部题目条（字体更大）
    ctx.fillStyle = "rgba(0,0,0,0.35)";
    ctx.fillRect(0,0,w,Math.max(40, GRID*1.9));
    ctx.fillStyle = "#ffffff";
    ctx.font = "bold " + Math.floor(GRID*1.0) + "px system-ui, -apple-system, Segoe UI, Roboto, Arial";
    ctx.textAlign = "left";
    ctx.textBaseline = "middle";
    ctx.fillText("题目： " + questionText, 12, Math.max(22, GRID*0.95));
  }

  init();
  requestAnimationFrame(loop);
})();
</script>
</body>
</html>
