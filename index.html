
<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>æ•°å­¦è´ªåƒè›‡ï¼ˆç®€åŒ–ç‰ˆ + å¤§çƒï¼‰</title>
<meta name="description" content="é¢˜ç›®æ›´ç®€å•ã€ç­”æ¡ˆçƒæ›´å¤§æ›´æ¸…æ™°çš„æ•°å­¦è´ªåƒè›‡ã€‚å¤ä¹ æ­£æŒ‡æ•°ã€è´ŸæŒ‡æ•°ã€å¹³æ–¹æ ¹ä¸åŸºç¡€å¯¹æ•°ã€‚">
<style>
  :root{--bg:#0b1020;--panel:#101935;--border:#3a4b8a;--pill:#1e2b54;--accent:#3a6df0;--grid:#ffffff0d;
        --snakeHead:#58ffb1;--snake:#2ee59d;--orb:#ffd166;--text:#e9ecf1;}
  *{box-sizing:border-box}
  body { background:var(--bg); color:var(--text); font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
         margin:0; display:flex; flex-direction:column; align-items:center; min-height:100vh; }
  h1 { font-weight:800; margin:16px 0 8px; text-align:center; }
  #wrap { position: relative; }
  #game { background:var(--panel); border:2px solid var(--border); box-shadow: 0 0 20px rgba(0,0,0,.35); display:block; }
  #hud { width:min(94vw, 640px); display:flex; flex-wrap:wrap; gap:8px; justify-content:space-between; margin:8px 0 16px; font-size:16px;}
  .pill { background:var(--pill); padding:8px 12px; border-radius:999px; font-size:18px; }
  #msg { position:absolute; inset:0; display:flex; align-items:center; justify-content:center;
         background:rgba(0,0,0,.55); color:#fff; font-size:20px; text-align:center; padding:16px; }
  #msg.hidden { display:none; }
  button { background:var(--accent); color:#fff; border:none; padding:12px 16px; border-radius:12px; cursor:pointer; font-weight:800; font-size:18px; }
  button:hover { filter:brightness(1.08); }
  #legend { width:min(94vw, 640px); font-size:16px; line-height:1.75; color:#cfd7ff; margin:10px 0 12px;text-align:left;}
  code { background:#17213f; padding:2px 6px; border-radius:6px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;}
  kbd { background:#222; border:1px solid #444; border-bottom-width:3px; padding:2px 8px; border-radius:6px;}
  .footer{opacity:.7; font-size:12px; margin:10px 0 30px;}
  @media (max-width:660px){
    #game{ width:94vw; height:94vw; }
    #hud{ width:94vw; }
  }
</style>
</head>
<body>
  <h1>ğŸ æ•°å­¦è´ªåƒè›‡ï¼ˆç®€åŒ–ç‰ˆ + å¤§çƒï¼‰</h1>
  <div id="legend">
    ç©æ³•ï¼šæŒ‰ <kbd>ç©ºæ ¼</kbd> å¼€å§‹/æš‚åœï¼Œä½¿ç”¨æ–¹å‘é”®ç§»åŠ¨ã€‚<br/>
    æœ¬ç‰ˆé¢˜ç›®æ›´ç®€å•ï¼šä»…åŒ…å« <b>æ­£æŒ‡æ•°</b>ã€<b>è´ŸæŒ‡æ•°</b>ã€<b>å¹³æ–¹æ ¹</b>ã€ä»¥åŠ <b>åŸºç¡€å¯¹æ•°</b>ï¼ˆåº• 2 æˆ– 4ï¼Œä¸”ç­”æ¡ˆä¸ºæ•´æ•°ï¼‰ã€‚<br/>
    çƒä½“æ›´å¤§ã€å­—ä½“æ›´ç²—ï¼Œæ›´å®¹æ˜“çœ‹æ¸…é€‰é¡¹ã€‚åƒåˆ°æ­£ç¡®ç­”æ¡ˆ âœ åŠ åˆ†å¹¶å˜é•¿ï¼›åƒé”™ âœ æ¸¸æˆç»“æŸã€‚
  </div>
  <div id="hud">
    <div class="pill">åˆ†æ•°ï¼š<span id="score">0</span></div>
    <div class="pill">é€Ÿåº¦ï¼š<span id="speed">ä¸­ç­‰</span></div>
    <div class="pill">å½“å‰é¢˜ï¼š<span id="qtext">æŒ‰ç©ºæ ¼å¼€å§‹</span></div>
  </div>
  <div id="wrap" style="width:min(94vw,640px);height:min(94vw,640px);">
    <canvas id="game" width="640" height="640"></canvas>
    <div id="msg" aria-live="polite">
      <div>
        <div style="font-size:26px; font-weight:900; margin-bottom:12px;">æŒ‰ <kbd>ç©ºæ ¼</kbd> å¼€å§‹ / æš‚åœ</div>
        <div style="opacity:.95">æ–¹å‘é”®ç§»åŠ¨ã€‚åƒå¯¹ç­”æ¡ˆå˜é•¿ï¼Œåƒé”™å°± GGã€‚<br/>å†æ¬¡æŒ‰ç©ºæ ¼å¯æš‚åœï¼Œé‡æ–°å¼€å§‹è¯·ç‚¹ä¸‹é¢æŒ‰é’®ã€‚</div>
        <div style="margin-top:16px;"><button id="restartBtn">é‡æ–°å¼€å§‹</button></div>
      </div>
    </div>
  </div>
  <div class="footer">Â© å­¦ä¹ ç”¨é€”ã€‚å¯è‡ªç”±åˆ†äº«æ­¤é¡µé¢æ–‡ä»¶ã€‚</div>

<script>
(function(){
  const canvas = document.getElementById('game');
  const ctx = canvas.getContext('2d');
  const wrap = document.getElementById('wrap');

  // è‡ªé€‚åº”æ­£æ–¹å½¢ç”»å¸ƒï¼ˆç§»åŠ¨ç«¯ï¼‰
  function fitCanvas(){
    const size = Math.min(wrap.clientWidth, wrap.clientHeight, 680);
    canvas.width = size;
    canvas.height = size;
  }
  window.addEventListener('resize', fitCanvas);
  fitCanvas();

  const W = () => canvas.width, H = () => canvas.height;
  const GRID = 24; // æ›´å¤§çš„æ ¼å­ï¼Œæ•°å­—æ›´æ¸…æ™°
  const COLS = () => Math.floor(W()/GRID);
  const ROWS = () => Math.floor(H()/GRID);
  const scoreEl = document.getElementById('score');
  const qtextEl = document.getElementById('qtext');
  const speedEl = document.getElementById('speed');
  const msg = document.getElementById('msg');
  const restartBtn = document.getElementById('restartBtn');

  let running = false;
  let lastTick = 0;
  let tickMs = 150; // ç¨å¾®æ…¢ä¸€ç‚¹ç‚¹
  let snake, dir, nextDir, score, answers, correctKey, questionText;

  function randInt(a,b){ return Math.floor(Math.random()*(b-a+1))+a; }
  function randCell(){
    return {x: randInt(0, COLS()-1), y: randInt(0, ROWS()-1)};
  }
  function cellEq(a,b){ return a.x===b.x && a.y===b.y; }

  function init(){
    snake = [{x:10,y:15},{x:9,y:15},{x:8,y:15}];
    dir = {x:1,y:0}; nextDir = {x:1,y:0};
    score = 0;
    tickMs = 150;
    speedEl.textContent = "ä¸­ç­‰";
    newQuestion();
    updateHud();
  }

  function updateHud(){
    scoreEl.textContent = score;
    qtextEl.textContent = questionText || "â€¦â€¦";
  }

  // ---- å‡ºé¢˜å™¨ï¼ˆç®€åŒ–ç‰ˆï¼‰ ----
  function asStr(x){
    if (typeof x === "number"){
      if (Math.abs(x-Math.round(x))<1e-9) return String(Math.round(x));
      return String(x.toFixed(3)).replace(/0+$/,'').replace(/\.$/,''); 
    }
    return String(x);
  }

  function q_pow_integer(){
    // a^n -> ?, a in [2..6], n in [1..4]
    const a = [2,3,4,5,6][randInt(0,4)];
    const n = randInt(1,4);
    const val = Math.pow(a,n);
    return { text: `${a}^${n} = ?`, correct: asStr(val) };
  }

  function q_pow_negative(){
    // a^{-n}ï¼Œa in [2..6], n in [1..3]
    const a = [2,3,4,5,6][randInt(0,4)];
    const n = randInt(1,3);
    return { text: `${a}^(-${n}) = ?`, correct: `1/${Math.pow(a,n)}` };
  }

  function q_pow_sqrt(){
    // a^{1/2}ï¼Œå®Œç¾å¹³æ–¹
    const choices = [{a:4, r:2},{a:9, r:3},{a:16,r:4},{a:25,r:5},{a:36,r:6}];
    const pick = choices[randInt(0, choices.length-1)];
    return { text: `${pick.a}^{1/2} = ?`, correct: asStr(pick.r) };
  }

  function q_log_basic(){
    // log_a(x)ï¼Œaâˆˆ{2,4}ï¼Œç»“æœä¸ºæ•´æ•°ï¼Œ-2..4
    const a = [2,4][randInt(0,1)];
    const k = randInt(-2,4);
    const x = Math.pow(a,k);
    return { text: `log_${a}(${x}) = ?`, correct: asStr(k) };
  }

  function q_mix(){
    const bank = [q_pow_integer, q_pow_negative, q_pow_sqrt, q_log_basic];
    return bank[randInt(0, bank.length-1)]();
  }

  function genDistractors(correctStr){
    // ç”Ÿæˆ 3 ä¸ªç®€å•å¹²æ‰°é¡¹ï¼šÂ±1ã€å€’æ•°ã€Ã—2
    const res = new Set([correctStr]);
    function tweak(str){
      if (/^-?\d+\/\d+$/.test(str)){
        const [n,d] = str.split('/').map(s=>parseInt(s,10));
        const pick = randInt(0,2);
        if (pick===0) return `${d}/${n}`; // å€’æ•°
        if (pick===1) return `${n+1}/${d}`;
        return `${Math.max(1,n-1)}/${d}`;
      } else if (/^-?\d+(\.\d+)?$/.test(str)){
        const v = parseFloat(str);
        const pick = randInt(0,3);
        if (pick===0) return String(v+1);
        if (pick===1) return String(v-1);
        if (pick===2 && v!==0) return `1/${Math.max(1,Math.round(Math.abs(v)))}`;
        return String(v*2);
      } else {
        return str + "'";
      }
    }
    let guard = 0;
    while(res.size<4 && guard<50){ res.add(tweak(correctStr)); guard++; }
    const arr = Array.from(res);
    // ä¿è¯åŒ…å«æ­£ç¡®ç­”æ¡ˆ
    if (!arr.includes(correctStr)) arr[randInt(0,arr.length-1)] = correctStr;
    // ç®€å•æ´—ç‰Œ
    for (let i=arr.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr.slice(0,4);
  }

  function newQuestion(){
    const q = q_mix();
    questionText = q.text;
    const opts = genDistractors(q.correct);
    placeAnswers(opts, q.correct);
    updateHud();
  }

  function placeAnswers(opts, correct){
    // éšæœºæ”¾ç½® 4 ä¸ªç­”æ¡ˆçƒï¼Œé¿å¼€è›‡èº«
    answers = [];
    for (let i=0;i<4;i++){
      let c, tries=0;
      do { c = randCell(); tries++; if(tries>200) break; }
      while ( snake.some(s=>cellEq(s,c)) || answers.some(o=>cellEq(o.pos,c)) );
      answers.push({ pos:c, text:opts[i] });
    }
    correctKey = correct;
  }

  // ---- è¾“å…¥ ----
  window.addEventListener('keydown', e=>{
    if (e.code === 'Space'){
      running = !running;
      msg.classList.toggle('hidden', running);
      return;
    }
    if (!running) return;
    if (e.key === 'ArrowUp' && dir.y!==1){ nextDir={x:0,y:-1}; }
    else if (e.key === 'ArrowDown' && dir.y!==-1){ nextDir={x:0,y:1}; }
    else if (e.key === 'ArrowLeft' && dir.x!==1){ nextDir={x:-1,y:0}; }
    else if (e.key === 'ArrowRight' && dir.x!==-1){ nextDir={x:1,y:0}; }
  });

  restartBtn.addEventListener('click', ()=>{
    init();
    running = false;
    msg.classList.remove('hidden');
  });

  // ---- å¾ªç¯ ----
  function loop(ts){
    requestAnimationFrame(loop);
    if (!running) return;
    if (ts - lastTick < tickMs) return;
    lastTick = ts;
    step();
    draw();
  }

  function step(){
    dir = nextDir;
    const head = {x: snake[0].x + dir.x, y: snake[0].y + dir.y};
    // è¾¹ç¼˜ç©¿è¶Šï¼Œé™ä½éš¾åº¦
    head.x = (head.x + COLS()) % COLS();
    head.y = (head.y + ROWS()) % ROWS();

    // æ’åˆ°è‡ªå·± => ç»“æŸ
    if (snake.some(s=>cellEq(s, head))){
      gameOver("æ’åˆ°è‡ªå·±å•¦ï¼");
      return;
    }
    snake.unshift(head);

    // åƒç­”æ¡ˆ
    let ate = false;
    for (let i=0;i<answers.length;i++){
      if (cellEq(answers[i].pos, head)){
        const picked = answers[i].text;
        if (picked === correctKey){
          score++;
          if (score % 6 === 0 && tickMs>80){ tickMs -= 10; speedEl.textContent = tickMs<=100 ? "è¾ƒå¿«" : "ä¸­ç­‰"; }
          newQuestion();
          ate = true; // å˜é•¿
        } else {
          gameOver("åƒé”™ç­”æ¡ˆäº†ï¼");
          return;
        }
      }
    }
    if (!ate){ snake.pop(); } // æ²¡åƒåˆ°å°±ç§»åŠ¨å°¾å·´
  }

  function gameOver(reason){
    running = false;
    draw();
    msg.classList.remove('hidden');
    msg.querySelector('div').firstChild.textContent = "æ¸¸æˆç»“æŸï¼š" + reason + " åˆ†æ•°ï¼š" + score + "ã€‚æŒ‰ç©ºæ ¼ç»§ç»­æˆ–ç‚¹é‡æ–°å¼€å§‹ã€‚";
  }

  function draw(){
    const w = W(), h = H();
    // èƒŒæ™¯
    ctx.fillStyle = "#0f1733";
    ctx.fillRect(0,0,w,h);
    // ç½‘æ ¼
    ctx.strokeStyle = "rgba(255,255,255,0.05)";
    ctx.lineWidth = 1;
    for (let x=0;x<=w;x+=GRID){ ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,h); ctx.stroke(); }
    for (let y=0;y<=h;y+=GRID){ ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(w,y); ctx.stroke(); }

    // è›‡
    for (let i=0;i<snake.length;i++){
      ctx.fillStyle = i===0 ? "#58ffb1" : "#2ee59d";
      const s = snake[i];
      ctx.fillRect(s.x*GRID+1, s.y*GRID+1, GRID-2, GRID-2);
    }

    // æ›´å¤§çš„ç­”æ¡ˆçƒ + æ›´å¤§å­—ä½“
    for (const a of answers){
      ctx.beginPath();
      ctx.fillStyle = "#ffd166";
      const cx = a.pos.x*GRID + GRID/2;
      const cy = a.pos.y*GRID + GRID/2;
      ctx.arc(cx, cy, GRID*0.48, 0, Math.PI*2); // åŠå¾„æ›´å¤§
      ctx.fill();
      ctx.fillStyle = "#102a43";
      ctx.font = "bold " + Math.floor(GRID*0.9) + "px system-ui, -apple-system, Segoe UI, Roboto, Arial"; // å­—ä½“æ›´å¤§
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
      ctx.fillText(a.text, cx, cy);
    }

    // é¡¶éƒ¨é¢˜ç›®æ¡ï¼ˆå­—ä½“æ›´å¤§ï¼‰
    ctx.fillStyle = "rgba(0,0,0,0.35)";
    ctx.fillRect(0,0,w,Math.max(40, GRID*1.9));
    ctx.fillStyle = "#ffffff";
    ctx.font = "bold " + Math.floor(GRID*1.0) + "px system-ui, -apple-system, Segoe UI, Roboto, Arial";
    ctx.textAlign = "left";
    ctx.textBaseline = "middle";
    ctx.fillText("é¢˜ç›®ï¼š " + questionText, 12, Math.max(22, GRID*0.95));
  }

  init();
  requestAnimationFrame(loop);
})();
</script>
</body>
</html>
