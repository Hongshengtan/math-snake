
<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>æ•°å­¦è´ªåƒè›‡ï¼šæŒ‡æ•°ä¸å¯¹æ•°ï¼ˆåœ¨çº¿ç‰ˆï¼‰</title>
<meta name="description" content="ç”¨æ–¹å‘é”®ç©è´ªåƒè›‡ï¼Œè¾¹ç©è¾¹å¤ä¹ æŒ‡æ•°ä¸å¯¹æ•°ã€‚é¢˜ç›®æ¶µç›–æ­£æŒ‡æ•°ã€è´ŸæŒ‡æ•°ã€åˆ†æ•°æŒ‡æ•°ä¸å¯¹æ•°ã€‚æŒ‰ç©ºæ ¼å¼€å§‹/æš‚åœã€‚">
<style>
  :root{--bg:#0b1020;--panel:#101935;--border:#3a4b8a;--pill:#1e2b54;--accent:#3a6df0;--grid:#ffffff0d;
        --snakeHead:#58ffb1;--snake:#2ee59d;--orb:#ffd166;--text:#e9ecf1;}
  *{box-sizing:border-box}
  body { background:var(--bg); color:var(--text); font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
         margin:0; display:flex; flex-direction:column; align-items:center; min-height:100vh; }
  h1 { font-weight:800; margin:16px 0 8px; text-align:center; }
  #wrap { position: relative; }
  #game { background:var(--panel); border:2px solid var(--border); box-shadow: 0 0 20px rgba(0,0,0,.35); display:block; }
  #hud { width:min(94vw, 640px); display:flex; flex-wrap:wrap; gap:8px; justify-content:space-between; margin:8px 0 16px; font-size:16px;}
  .pill { background:var(--pill); padding:6px 10px; border-radius:999px; }
  #msg { position:absolute; inset:0; display:flex; align-items:center; justify-content:center;
         background:rgba(0,0,0,.55); color:#fff; font-size:18px; text-align:center; padding:16px; }
  #msg.hidden { display:none; }
  button { background:var(--accent); color:#fff; border:none; padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:700; }
  button:hover { filter:brightness(1.08); }
  #legend { width:min(94vw, 640px); font-size:14px; line-height:1.65; color:#cfd7ff; margin:10px 0 12px;text-align:left;}
  code { background:#17213f; padding:2px 6px; border-radius:6px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;}
  kbd { background:#222; border:1px solid #444; border-bottom-width:3px; padding:1px 6px; border-radius:6px;}
  .footer{opacity:.7; font-size:12px; margin:10px 0 30px;}
  @media (max-width:660px){
    #game{ width:94vw; height:94vw; }
    #hud{ width:94vw; }
  }
</style>
</head>
<body>
  <h1>ğŸ æ•°å­¦è´ªåƒè›‡ï¼šæŒ‡æ•°ä¸å¯¹æ•°ï¼ˆåœ¨çº¿ç‰ˆï¼‰</h1>
  <div id="legend">
    ç©æ³•ï¼šæŒ‰ <kbd>ç©ºæ ¼</kbd> å¼€å§‹/æš‚åœï¼Œä½¿ç”¨æ–¹å‘é”®ç§»åŠ¨ã€‚å±å¹•ä¸Šæ–¹æ˜¾ç¤ºé¢˜ç›®ï¼Œåœ°å›¾ä¸Šæœ‰ 4 ä¸ªâ€œç­”æ¡ˆçƒâ€ã€‚<br/>
    åƒåˆ°æ­£ç¡®ç­”æ¡ˆ âœ åŠ åˆ†å¹¶å˜é•¿ï¼›åƒé”™ âœ æ¸¸æˆç»“æŸã€‚é¢˜ç›®èŒƒå›´ï¼šæ­£æŒ‡æ•°ã€è´ŸæŒ‡æ•°ã€åˆ†æ•°æŒ‡æ•°ï¼ˆå¦‚ <code>a^{1/2}</code>ã€<code>8^{2/3}</code>ï¼‰ã€å¯¹æ•° <code>log_a(x)</code>ã€‚<br/>
    å°æŠ€å·§ï¼š<b>è´ŸæŒ‡æ•°=å€’æ•°</b>ï¼›<b>åˆ†æ¯=å¼€å‡ æ¬¡æ–¹ï¼Œåˆ†å­=å†ä¹˜å‡ æ¬¡</b>ï¼›<b>log_a(x)</b> é—®çš„æ˜¯ â€œa çš„å‡ æ¬¡æ–¹ç­‰äº xâ€ã€‚
  </div>
  <div id="hud">
    <div class="pill">åˆ†æ•°ï¼š<span id="score">0</span></div>
    <div class="pill">é€Ÿåº¦ï¼š<span id="speed">ä¸­ç­‰</span></div>
    <div class="pill">å½“å‰é¢˜ï¼š<span id="qtext">æŒ‰ç©ºæ ¼å¼€å§‹</span></div>
  </div>
  <div id="wrap" style="width:min(94vw,640px);height:min(94vw,640px);">
    <canvas id="game" width="600" height="600"></canvas>
    <div id="msg" aria-live="polite">
      <div>
        <div style="font-size:22px; font-weight:800; margin-bottom:10px;">æŒ‰ <kbd>ç©ºæ ¼</kbd> å¼€å§‹ / æš‚åœ</div>
        <div style="opacity:.95">æ–¹å‘é”®ç§»åŠ¨ã€‚åƒå¯¹ç­”æ¡ˆå˜é•¿ï¼Œåƒé”™å°± GGã€‚<br/>å†æ¬¡æŒ‰ç©ºæ ¼å¯æš‚åœï¼Œé‡æ–°å¼€å§‹è¯·ç‚¹ä¸‹é¢æŒ‰é’®ã€‚</div>
        <div style="margin-top:16px;"><button id="restartBtn">é‡æ–°å¼€å§‹</button></div>
      </div>
    </div>
  </div>
  <div class="footer">Â© å­¦ä¹ ç”¨é€”ã€‚å¯è‡ªç”±åˆ†äº«æ­¤é¡µé¢æ–‡ä»¶ã€‚</div>

<script>
(function(){
  const canvas = document.getElementById('game');
  const ctx = canvas.getContext('2d');
  const wrap = document.getElementById('wrap');

  // è‡ªé€‚åº”æ­£æ–¹å½¢ç”»å¸ƒï¼ˆç§»åŠ¨ç«¯ï¼‰
  function fitCanvas(){
    const size = Math.min(wrap.clientWidth, wrap.clientHeight);
    canvas.width = size;
    canvas.height = size;
  }
  window.addEventListener('resize', fitCanvas);
  fitCanvas();

  const W = () => canvas.width, H = () => canvas.height;
  const GRID = 20; // åŸºç¡€æ ¼å•ä½ï¼Œç”¨åƒç´ æ¢ç®—è‡³ç½‘æ ¼æ•°é‡
  const COLS = () => Math.floor(W()/GRID);
  const ROWS = () => Math.floor(H()/GRID);
  const scoreEl = document.getElementById('score');
  const qtextEl = document.getElementById('qtext');
  const speedEl = document.getElementById('speed');
  const msg = document.getElementById('msg');
  const restartBtn = document.getElementById('restartBtn');

  let running = false;
  let lastTick = 0;
  let tickMs = 140; // é€Ÿåº¦
  let snake, dir, nextDir, score, answers, correctKey, questionText;

  function randInt(a,b){ return Math.floor(Math.random()*(b-a+1))+a; }
  function randCell(){
    return {x: randInt(0, COLS()-1), y: randInt(0, ROWS()-1)};
  }
  function cellEq(a,b){ return a.x===b.x && a.y===b.y; }

  function init(){
    snake = [{x:10,y:15},{x:9,y:15},{x:8,y:15}];
    dir = {x:1,y:0}; nextDir = {x:1,y:0};
    score = 0;
    tickMs = 140;
    speedEl.textContent = "ä¸­ç­‰";
    newQuestion();
    updateHud();
  }

  function updateHud(){
    scoreEl.textContent = score;
    qtextEl.textContent = questionText || "â€¦â€¦";
  }

  // ---- å‡ºé¢˜å™¨ ----
  function formatFrac(numer, denom){
    if(denom===1) return String(numer);
    return (numer<0?"-":"") + Math.abs(numer) + "/" + denom;
  }

  function simplifyFraction(n, d){
    function g(a,b){ return b?g(b,a%b):Math.abs(a); }
    const g0 = g(n,d);
    return [n/g0, d/g0];
  }

  function asStr(x){
    if (typeof x === "number"){
      if (Math.abs(x-Math.round(x))<1e-9) return String(Math.round(x));
      return String(x.toFixed(3)).replace(/0+$/,'').replace(/\.$/,''); 
    }
    if (x && x.frac){
      const [n,d] = simplifyFraction(x.frac[0], x.frac[1]);
      return formatFrac(n,d);
    }
    return String(x);
  }

  function q_pow_integer(){
    const a = [2,3,4,5,6,7,8,9][randInt(0,7)];
    const n = randInt(1,5);
    const val = Math.pow(a,n);
    return { text: `${a}^${n} = ?`, correct: asStr(val), topic:"powInt" };
  }

  function q_pow_negative(){
    const a = [2,3,4,5,6,9][randInt(0,5)];
    const n = randInt(1,3);
    return { text: `${a}^(-${n}) = ?`, correct: asStr({frac:[1, Math.pow(a,n)]}), topic:"powNeg" };
  }

  function q_pow_fraction_simple(){
    const choices = [{a:4, r:2},{a:9, r:3},{a:16,r:4},{a:25,r:5}];
    const pick = choices[randInt(0, choices.length-1)];
    return { text: `${pick.a}^{1/2} = ?`, correct: asStr(pick.r), topic:"powFrac12" };
  }

  function q_pow_fraction_23(){
    const items = [{a:8, num:2, den:3, r:4},{a:27,num:1,den:3,r:3},{a:32,num:1,den:5,r:2},{a:81,num:1,den:4,r:3}];
    const t = items[randInt(0, items.length-1)];
    return { text: `${t.a}^{${t.num}/${t.den}} = ?`, correct: asStr(t.r), topic:"powFrac" };
  }

  function q_log_integer(){
    const a = [2,3,4,5,10][randInt(0,4)];
    const k = randInt(-3,4);
    const x = Math.pow(a,k);
    return { text: `log_${a}(${x}) = ?`, correct: asStr(k), topic:"logInt" };
  }

  function q_mix(){
    const bank = [q_pow_integer, q_pow_negative, q_pow_fraction_simple, q_pow_fraction_23, q_log_integer];
    return bank[randInt(0, bank.length-1)]();
  }

  function genDistractors(correctStr){
    const res = new Set();
    res.add(correctStr);
    function tweak(str){
      if (/^-?\d+\/\d+$/.test(str)){
        const [n,d] = str.split('/').map(s=>parseInt(s,10));
        const pick = randInt(0,2);
        if (pick===0) return asStr({frac:[d,n]});
        if (pick===1) return asStr({frac:[n+1, d]});
        return asStr({frac:[n-1, d]});
      } else if (/^-?\d+(\.\d+)?$/.test(str)){
        const v = parseFloat(str);
        const pick = randInt(0,3);
        if (pick===0) return asStr(v+1);
        if (pick===1) return asStr(v-1);
        if (pick===2 && v!==0) return asStr({frac:[1, Math.max(1,Math.round(Math.abs(v)))]});
        return asStr(v*2);
      } else { return str + "'"; }
    }
    let guard = 0;
    while(res.size<4 && guard<60){ res.add(tweak(correctStr)); guard++; }
    const arr = Array.from(res);
    return shuffle(arr).slice(0,4);
  }

  function shuffle(a){
    for(let i=a.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [a[i], a[j]] = [a[j], a[i]];
    }
    return a;
  }

  function newQuestion(){
    const q = q_mix();
    questionText = q.text;
    const opts = genDistractors(q.correct);
    if (!opts.includes(q.correct)) { opts[randInt(0,3)] = q.correct; }
    placeAnswers(opts, q.correct);
    updateHud();
  }

  function placeAnswers(opts, correct){
    // éšæœºæ”¾ç½® 4 ä¸ªç­”æ¡ˆçƒï¼Œé¿å¼€è›‡èº«
    answers = [];
    for (let i=0;i<4;i++){
      let c;
      let tries=0;
      do { c = randCell(); tries++; if(tries>200) break; }
      while ( snake.some(s=>cellEq(s,c)) || answers.some(o=>cellEq(o.pos,c)) );
      answers.push({ pos:c, text:opts[i] });
    }
    correctKey = correct;
  }

  // ---- è¾“å…¥ ----
  window.addEventListener('keydown', e=>{
    if (e.code === 'Space'){
      running = !running;
      msg.classList.toggle('hidden', running);
      return;
    }
    if (!running) return;
    if (e.key === 'ArrowUp' && dir.y!==1){ nextDir={x:0,y:-1}; }
    else if (e.key === 'ArrowDown' && dir.y!==-1){ nextDir={x:0,y:1}; }
    else if (e.key === 'ArrowLeft' && dir.x!==1){ nextDir={x:-1,y:0}; }
    else if (e.key === 'ArrowRight' && dir.x!==-1){ nextDir={x:1,y:0}; }
  });

  restartBtn.addEventListener('click', ()=>{
    init();
    running = false;
    msg.classList.remove('hidden');
  });

  // ---- å¾ªç¯ ----
  function loop(ts){
    requestAnimationFrame(loop);
    if (!running) return;
    if (ts - lastTick < tickMs) return;
    lastTick = ts;
    step();
    draw();
  }

  function step(){
    dir = nextDir;
    const head = {x: snake[0].x + dir.x, y: snake[0].y + dir.y};
    // è¾¹ç¼˜ç©¿è¶Šï¼Œé™ä½éš¾åº¦
    head.x = (head.x + COLS()) % COLS();
    head.y = (head.y + ROWS()) % ROWS();

    // æ’åˆ°è‡ªå·± => ç»“æŸ
    if (snake.some(s=>cellEq(s, head))){
      gameOver("æ’åˆ°è‡ªå·±å•¦ï¼");
      return;
    }
    snake.unshift(head);

    // åƒç­”æ¡ˆ
    let ate = false;
    for (let i=0;i<answers.length;i++){
      if (cellEq(answers[i].pos, head)){
        const picked = answers[i].text;
        if (picked === correctKey){
          score++;
          if (score % 5 === 0 && tickMs>70){ tickMs -= 10; speedEl.textContent = tickMs<=90 ? "å¾ˆå¿«" : "ä¸­ç­‰"; }
          newQuestion();
          ate = true; // å˜é•¿
        } else {
          gameOver("åƒé”™ç­”æ¡ˆäº†ï¼");
          return;
        }
      }
    }
    if (!ate){ snake.pop(); } // æ²¡åƒåˆ°å°±ç§»åŠ¨å°¾å·´
  }

  function gameOver(reason){
    running = false;
    draw();
    msg.classList.remove('hidden');
    msg.querySelector('div').firstChild.textContent = "æ¸¸æˆç»“æŸï¼š" + reason + " åˆ†æ•°ï¼š" + score + "ã€‚æŒ‰ç©ºæ ¼ç»§ç»­æˆ–ç‚¹é‡æ–°å¼€å§‹ã€‚";
  }

  function draw(){
    const w = W(), h = H();
    // èƒŒæ™¯
    ctx.fillStyle = "#0f1733";
    ctx.fillRect(0,0,w,h);
    // ç½‘æ ¼
    ctx.strokeStyle = "rgba(255,255,255,0.05)";
    ctx.lineWidth = 1;
    for (let x=0;x<=w;x+=GRID){ ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,h); ctx.stroke(); }
    for (let y=0;y<=h;y+=GRID){ ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(w,y); ctx.stroke(); }

    // è›‡
    for (let i=0;i<snake.length;i++){
      ctx.fillStyle = i===0 ? "#58ffb1" : "#2ee59d";
      const s = snake[i];
      ctx.fillRect(s.x*GRID+1, s.y*GRID+1, GRID-2, GRID-2);
    }

    // ç­”æ¡ˆçƒ
    for (const a of answers){
      ctx.beginPath();
      ctx.fillStyle = "#ffd166";
      const cx = a.pos.x*GRID + GRID/2;
      const cy = a.pos.y*GRID + GRID/2;
      ctx.arc(cx, cy, GRID*0.38, 0, Math.PI*2);
      ctx.fill();
      ctx.fillStyle = "#102a43";
      ctx.font = "bold " + Math.floor(GRID*0.7) + "px system-ui, -apple-system, Segoe UI, Roboto, Arial";
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
      ctx.fillText(a.text, cx, cy);
    }

    // é¡¶éƒ¨é¢˜ç›®æ¡
    ctx.fillStyle = "rgba(0,0,0,0.35)";
    ctx.fillRect(0,0,w,Math.max(34, GRID*1.7));
    ctx.fillStyle = "#ffffff";
    ctx.font = "bold " + Math.floor(GRID*0.9) + "px system-ui, -apple-system, Segoe UI, Roboto, Arial";
    ctx.textAlign = "left";
    ctx.textBaseline = "middle";
    ctx.fillText("é¢˜ç›®ï¼š " + questionText, 10, Math.max(17, GRID*0.85));
  }

  init();
  requestAnimationFrame(loop);
})();
</script>
</body>
</html>
